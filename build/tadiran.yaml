# Global for TZ string
globals:
  - id: tz_string
    type: char[64]
    restore_value: yes  # Persist across reboots
    initial_value: '{"UTC"}'

substitutions:
  node_name: tadiran # Use a unique name.
  node_id: Tadiran_ac    # Use a unique id.
  friendly_node_name: "Tadiran AC"
#  deviceid: gree
#  devicename: workroom

esphome:
  name: tadiran
  friendly_name: "Tadiran AC"

esp8266:
  board: esp01_1m

# Enable Home Assistant API
api:

web_server:
  port: 80
  local: true

captive_portal:

ota:
  - platform: web_server

wifi:
  # Enable fallback hotspot (captive portal) in case wifi connection fails
  ap:
    ssid: "tadiran-wifi"
    password: "1234567890"


# Enable logging
logger:
  baud_rate: 0 # disable LOG output on UART as UART is used for Sinclair AC unit
  level: VERBOSE

uart:
  tx_pin: 1
  rx_pin: 3
  baud_rate: 4800
  parity: EVEN

time:
  - platform: sntp

# Select entity: Dropdown with common timezones
select:
  - platform: template
    name: "Timezone"
    id: tz_select
    mode: dropdown  # Required: renders as dropdown in web UI
    optimistic: true
    initial_option: "UTC"
    options:
      # Common IANA TZ strings (expand via Python script if needed)
      - "UTC"
      - "Asia/Jerusalem"
      - "Europe/Kyiv"
      - "Etc/GMT+2"
    set_action:
      - lambda: |-
          const char* new_tz = x.c_str();
          strncpy(id(tz_string), new_tz, sizeof(id(tz_string)) - 1);
          id(tz_string)[sizeof(id(tz_string)) - 1] = '\0';
          // Apply TZ immediately
          setenv("TZ", id(tz_string), 1);
          tzset();
          // Force time sync
          id(sntp_time).update();

# Sensor to display current applied TZ (for verification)
sensor:
  - platform: template
    name: "Current Timezone"
    lambda: |-
      return {id(tz_string)};
    update_interval: never
    on_value:
      then:
        - lambda: |-
            id(tz_select).publish_state(id(tz_string));

external_components:
  - source: github://gekkehenkie11/esphome_gree_ac
    components: [sinclair_ac]
    refresh: 0s

climate:
  - platform: sinclair_ac
    name: ${devicename}
    horizontal_swing_select:
      name: Horizontal Swing Mode
    vertical_swing_select:
      name: Vertical Swing Mode
    display_select:
      name: Display Mode
    display_unit_select:
      name: Display Unit
    plasma_switch:
      name: Plasma
    beeper_switch:
      name: Beeper      
    sleep_switch:
      name: Sleep
    xfan_switch:
      name: X-fan
    save_switch:
      name: Save/8 Heat  
    
